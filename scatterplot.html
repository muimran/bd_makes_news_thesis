// MONTHLY AGGREGATION

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Article Publication Frequency Over Time</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .chart-container {
            width: 75%;
            height: 60vh;
            margin: 50px auto;
        }
        .bar {
            fill: steelblue;
        }
        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            width: 80px;
            height: 28px;
            padding: 2px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }
    </style>
</head>
<body>

<div class="chart-container">
    <svg width="100%" height="100%"></svg>
</div>

<script>
  // Load and process the data
  d3.json('article_details.json').then(data => {
      const articlesPerPeriod = {};

      // Choose your aggregation period here
      const aggregationPeriod = 2;  // Change this to 2 for 2-monthly, 3 for 3-monthly, etc.

      // Process each article to group by custom period and year
      data.forEach(article => {
          const date = new Date(article.date);
          const year = date.getFullYear();
          const month = date.getMonth() + 1;  // getMonth() returns 0-based month

          // Determine which period the current month falls into
          const period = Math.ceil(month / aggregationPeriod);

          // Create a key for grouping articles, like "2023-P1" for Jan-Feb 2023, "2023-P2" for Mar-Apr 2023, etc.
          const periodKey = `${year}-P${String(period).padStart(2, '0')}`;

          articlesPerPeriod[periodKey] = (articlesPerPeriod[periodKey] || 0) + 1;
      });

      // Prepare the data for D3
      const formattedData = Object.entries(articlesPerPeriod).map(([period, count]) => {
          const [year, periodNumber] = period.split('-P');
          const month = (parseInt(periodNumber) - 1) * aggregationPeriod + 1;
          return {
              month: new Date(year, month - 1, 1),  // Convert to Date object
              count
          };
      });

      // Sort the data by date in ascending order
      formattedData.sort((a, b) => a.month - b.month);

      createBarChart(formattedData);
  });

  // Function to create a bar chart
  function createBarChart(data) {
      const svg = d3.select('svg');
      const margin = { top: 20, right: 30, bottom: 50, left: 50 };
      const width = parseInt(svg.style('width')) - margin.left - margin.right;
      const height = parseInt(svg.style('height')) - margin.top - margin.bottom;

      const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

      const x = d3.scaleBand()
                  .domain(data.map(d => d.month))
                  .range([0, width])
                  .padding(0.1);

      const y = d3.scaleLinear()
                  .domain([0, d3.max(data, d => d.count)])
                  .nice()
                  .range([height, 0]);

      // Create tooltip
      const tooltip = d3.select('body').append('div')
          .attr('class', 'tooltip')
          .style('opacity', 0);

      g.append('g')
        .selectAll('.bar')
        .data(data)
        .enter().append('rect')
          .attr('class', 'bar')
          .attr('x', d => x(d.month))
          .attr('y', d => y(d.count))
          .attr('width', x.bandwidth())
          .attr('height', d => height - y(d.count))
          .on('mouseover', (event, d) => {
              tooltip.transition()
                  .duration(200)
                  .style('opacity', .9);
              tooltip.html(`${d3.timeFormat("%B %Y")(d.month)}<br>${d.count} articles`)
                  .style('left', (event.pageX + 5) + 'px')
                  .style('top', (event.pageY - 28) + 'px');
          })
          .on('mouseout', () => {
              tooltip.transition()
                  .duration(500)
                  .style('opacity', 0);
          });

      g.append('g')
        .attr('class', 'x axis')
        .attr('transform', `translate(0,${height})`)
        .call(d3.axisBottom(x).tickFormat(d3.timeFormat("%Y")).ticks(d3.timeYear.every(1)))
        .selectAll("text")
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", ".15em")
        .attr("transform", "rotate(-65)");

      g.append('g')
        .attr('class', 'y axis')
        .call(d3.axisLeft(y));
  }
</script>
