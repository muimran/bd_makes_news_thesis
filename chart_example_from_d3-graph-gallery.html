<!DOCTYPE html>
<html>
<head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <style>
        #container {
            height: 240px; /* Reduced height by 40% */
            width: 480px; /* Reduced width by 40% */
            position: absolute; /* Positioning closer to the first chart */
            top: 50px; /* Adjust as needed to align vertically */
            left: 800px; /* Adjust this value to keep it in its current position relative to the new width */
        }
        .tooltip {
            position: absolute;
            text-align: center;
            width: auto;
            height: auto;
            padding: 5px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 1px solid #d3d3d3;
            border-radius: 4px;
            pointer-events: none;
        }
        #chart1 {
            float: left;
        }
    </style>
</head>
<body>

<div id="chart1"></div>
<div id="container"></div>

<script>
// Set the dimensions and margins of the graph
const margin = {top: 40, right: 30, bottom: 60, left: 30},
      width = 720 - margin.left - margin.right, // Increased width by 20%
      height = 600 - margin.top - margin.bottom;

// Append the svg object to the body of the page
const svg = d3.select("#chart1")
    .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

// Tooltip setup
const tooltip = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);

// Load the CSV data for the D3 chart
d3.csv("top100_words.csv").then(data => {
    // Nest data by Publication
    const nestedData = d3.groups(data, d => d.Publication);

    // Sort the data within each publication by frequency in descending order
    nestedData.forEach(pub => {
        pub[1].sort((a, b) => d3.descending(+a.Frequency, +b.Frequency));
    });

    // Set the scales
    const x = d3.scaleBand()
        .domain(nestedData.map(d => d[0]))
        .range([0, width * .5])
        .padding(0.2);

    const y = d3.scaleLinear()
        .domain([0, 100])  // 100 words per publication
        .range([height, 0]);

    const barHeight = height / 110;  // Adjusted thickness for bars with space

    // Calculate the position for the tooltip (to the right of the rightmost column)
    const rightMostColumnX = x(nestedData[nestedData.length - 1][0]) + x.bandwidth();
    const tooltipX = rightMostColumnX + margin.left + 20; // 20 pixels to the right of the rightmost column

    // X Axis
    svg.append("g")
        .attr("transform", `translate(0, ${height})`)
        .call(d3.axisBottom(x).tickSize(0).tickFormat(''))
        .selectAll("text")
        .remove();  // Remove the publication names (ticks) on X axis
    svg.selectAll(".domain").remove();  // This line removes the x-axis line

    // Draw bars
    nestedData.forEach(pub => {
        const pubName = pub[0];
        const words = pub[1];

        svg.selectAll(`.bar-${pubName}`)
            .data(words)
            .enter()
            .append("rect")
            .attr("class", `bar-${pubName}`)
            .attr("x", d => x(pubName))
            .attr("y", (d, i) => i * (barHeight + .6))  // Modify this line to add a vertical gap
            .attr("width", x.bandwidth())
            .attr("height", barHeight)
            .attr("fill", "steelblue")
            .on("mouseover", function(event, d) {
                // Highlight all bars with the same word across all columns
                svg.selectAll("rect").filter(function(dd) {
                    return dd.Word === d.Word;
                }).attr("fill", "orange");

                // Update tooltip content
                tooltip.transition().duration(200).style("opacity", .9);
                tooltip.html(d.Word.toUpperCase());

                // Position the tooltip to the right of the rightmost column
                tooltip.style("left", tooltipX + "px")
                       .style("top", (event.pageY - 10) + "px"); // Adjust vertical position as needed
            })
            .on("mouseout", function() {
                // Reset the color of all bars to steelblue
                svg.selectAll("rect").attr("fill", "steelblue");

                tooltip.transition().duration(500).style("opacity", 0);
            })
            .on("click", function(event, d) {
                // Load data for the clicked word
                d3.csv("top100_words_articles_yearwise.csv").then(fullData => {
                    // Filter data for the selected word
                    const wordData = fullData.filter(row => row.Word.toLowerCase() === d.Word.toLowerCase());

                    // Sort the filtered data by year
                    wordData.sort((a, b) => d3.ascending(+a.Year, +b.Year));

                    // Extract years and frequencies for Highcharts
                    const years = wordData.map(row => +row.Year);
                    const frequencies = wordData.map(row => +row.Frequency);

                    // Update Highcharts with the new data
                    Highcharts.chart('container', {
                        chart: {
                            type: 'spline',
                            animation: {
                                duration: 1000
                            }
                        },
                        title: {
                            text: `Frequency of the Word "${d.Word}" Over Time`,
                            align: 'left'
                        },
                        xAxis: {
                            categories: years,
                            title: {
                                text: null
                            },
                            gridLineWidth: 0,
                            labels: {
                                formatter: function() {
                                    return (this.value == years[0] || this.value == years[years.length - 1]) ? this.value : '';
                                }
                            }
                        },
                        yAxis: {
                            title: {
                                text: null
                            },
                            gridLineWidth: 0,
                            labels: {
                                enabled: true
                            }
                        },
                        plotOptions: {
                            series: {
                                marker: {
                                    enabled: false
                                },
                                lineWidth: 2,
                                animation: {
                                    duration: 1000
                                },
                                label: {
                                    enabled: false
                                }
                            }
                        },
                        series: [{
                            data: frequencies,
                            showInLegend: false
                        }],
                        exporting: {
                            enabled: false
                        },
                        credits: {
                            enabled: false
                        }
                    });
                });
            });
    });

    // Add publication logos under each column
    svg.selectAll(".logo")
        .data(nestedData)
        .enter()
        .append("image")
        .attr("xlink:href", d => d[1][0].Logo)
        .attr("x", d => x(d[0]) + (x.bandwidth() - 50) / 2)  // Center the logo
        .attr("y", height + 20)
        .attr("width", 50)
        .attr("height", 50);
});

</script>

</body>
</html>
